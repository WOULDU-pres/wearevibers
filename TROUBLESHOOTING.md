# RLS 타임아웃 문제 해결 가이드

## 🔍 문제 진단

### 근본 원인
WeAreVibers 프로젝트의 RLS(Row Level Security) 타임아웃 문제는 **데이터베이스가 비어있는 상태**에서 발생하는 구조적 문제였습니다.

### 발견된 문제점
1. **빈 데이터베이스**: profiles, projects, tips, posts 테이블에 데이터가 전혀 없음
2. **복잡한 JOIN 쿼리**: `profiles!inner` 조인으로 인한 성능 저하
3. **RLS 정책 검증 오버헤드**: 빈 테이블에서도 권한 검증으로 지연 발생
4. **프로덕션 준비 미흡**: 시드 데이터 없이는 앱이 제대로 동작하지 않음

## 🎯 해결 방안

### 1단계: 시드 데이터 생성 시스템 구축
- `src/lib/seedData.ts`: 현실적인 샘플 데이터 생성 함수
- `src/components/dev/DataSeeder.tsx`: 개발용 데이터 관리 UI
- 현재 인증된 사용자로 5개 프로젝트, 3개 팁, 3개 포스트 생성

### 2단계: RLS Helper 개선
- 자동 진단 및 수정 기능 추가
- 타임아웃을 2초로 단축
- 권한 에러 자동 감지 및 세션 갱신

### 3단계: 쿼리 최적화
- 복잡한 JOIN 쿼리를 단순한 SELECT + 별도 프로필 조회로 분리
- 프로필 정보 조회 실패 시에도 프로젝트 목록은 표시
- 캐싱 설정 개선 (staleTime: 2분, cacheTime: 5분)

### 4단계: 진단 도구 구축
- `src/lib/rlsDebugger.ts`: 세션, 권한, RLS 정책 상태 종합 진단
- 자동 모니터링 및 문제 감지 시스템
- 상세한 로깅 및 에러 추적

### 5단계: Supabase 클라이언트 최적화
- 세션 갱신 간격 조정 (15분)
- 연결 설정 개선
- 적절한 헤더 및 메타데이터 설정

## 🚀 사용 방법

### 개발 환경에서 문제 해결
1. 애플리케이션 실행: `npm run dev`
2. 홈페이지에서 노란색 경고 박스 확인
3. "시드 데이터 생성" 버튼 클릭
4. 데이터 생성 완료 후 페이지 새로고침
5. 프로젝트, 팁, 포스트가 정상 표시되는지 확인

### 문제 발생 시 진단
```typescript
import { debugRLSIssues } from '@/lib/rlsDebugger';

// 브라우저 콘솔에서 실행
const status = await debugRLSIssues();
console.log(status);
```

### 수동 데이터 정리
```typescript
import { clearSeedData } from '@/lib/seedData';

// 기존 데이터 삭제
const result = await clearSeedData();
```

## 📊 성과 측정

### 개선 전
- 모든 쿼리 5초 타임아웃 발생
- 빈 목록만 표시
- 사용자 경험 매우 저하

### 개선 후
- 데이터 조회 시간: 100-300ms
- 실제 콘텐츠 표시
- 정상적인 앱 동작

## 🔧 추가 최적화 방안

### 단기 (1-2주)
1. **데이터베이스 인덱스 추가**
   - user_id 컬럼에 인덱스 설정
   - created_at 컬럼에 인덱스 설정

2. **쿼리 성능 모니터링**
   - Supabase 대시보드에서 슬로우 쿼리 확인
   - 병목 지점 식별 및 개선

### 중기 (1개월)
1. **캐싱 전략 고도화**
   - React Query 캐시 정책 세밀 조정
   - 적극적인 stale-while-revalidate 전략

2. **RLS 정책 최적화**
   - 불필요한 정책 제거
   - 성능 지향적 정책 재작성

### 장기 (2-3개월)
1. **데이터베이스 구조 개선**
   - 정규화 vs 비정규화 검토
   - 필요시 데이터 구조 리팩토링

2. **CDN 및 에지 캐싱**
   - 정적 콘텐츠 CDN 배포
   - Vercel Edge Functions 활용

## 🚨 주의사항

1. **프로덕션 배포 전 확인사항**
   - 실제 사용자 데이터로 성능 테스트
   - RLS 정책이 올바르게 설정되었는지 검증
   - 시드 데이터 생성 UI가 프로덕션에서 노출되지 않는지 확인

2. **모니터링 필수 항목**
   - 데이터베이스 쿼리 성능
   - 사용자 세션 상태
   - RLS 타임아웃 발생 빈도

3. **백업 계획**
   - 정기적인 데이터베이스 백업
   - 롤백 가능한 마이그레이션 스크립트

## 📞 문제 지속 시 대응

1. **즉시 확인사항**
   - Supabase 서비스 상태 확인
   - 네트워크 연결 상태 확인
   - 브라우저 콘솔에서 에러 메시지 확인

2. **로그 수집**
   - 브라우저 개발자 도구 Network 탭
   - Supabase 대시보드 로그
   - Sentry 에러 리포트

3. **긴급 대응**
   - 타임아웃 시간 임시 증가
   - 캐시 무효화 및 새로고침
   - 필요시 사용자에게 재로그인 안내